<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tester WebSocket Requisitos</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 1rem; background: #fff; color: #333; }
    #controls { margin-bottom: 1rem; }
    #log {
      background: #f8f8f8;
      padding: 1rem;
      height: 300px;
      overflow-y: auto;
      white-space: pre-wrap;
      border: 1px solid #ccc;
      font-family: monospace;
    }
    input, button { font-size: 1rem; margin: .2rem; }
    table { border-collapse: collapse; }
    td { padding: 4px; vertical-align: middle; }
    .log-info    { color: #0074d9; }
    .log-send    { color: #2ecc40; }
    .log-receive { color: #ff851b; }
    .log-error   { color: #ff4136; }
  </style>
</head>
<body>

<h1>‚úÖ Tester WebSocket - Simulaci√≥n Requisitos</h1>

<div id="controls">
  <table>
    <tr>
      <td><label for="varName">varName:</label></td>
      <td><input type="text" id="varName" value="pepe" /></td>
    </tr>
    <tr>
      <td colspan="2">
        <button id="btnSub">‚úÖ Subscribirse</button>
        <button id="btnUnsub" disabled>‚ùå Desubscribirse</button>
        <button onclick="clearLog()">üßπ Limpiar Log</button>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <button onclick="testReenvio()">üß™ Reenviar √∫ltimo mensaje</button>
        <button onclick="sendCustom()">üß™ Enviar mensaje personalizado</button>
      </td>
    </tr>
  </table>
</div>

<div id="log"></div>

<script>
  const logEl = document.getElementById('log');
  const varInput = document.getElementById('varName');

  const socket = new WebSocket('ws://localhost:9102/ws');

  socket.addEventListener('open', () => appendLog('‚úÖ Conexi√≥n WebSocket abierta', 'info'));
  socket.addEventListener('close', () => appendLog('‚ùå Conexi√≥n cerrada', 'error'));
  socket.addEventListener('error', () => appendLog('‚ö†Ô∏è Error en WebSocket', 'error'));

  socket.addEventListener('message', (e) => {
    try {
      const json = JSON.parse(e.data);
      appendLog('üì• JSON recibido:\n' + JSON.stringify(json, null, 2), 'receive');
    } catch {
      appendLog('üì• Texto recibido: ' + e.data, 'receive');
    }
  });

  document.getElementById('btnSub').onclick = () => {
    const varName = varInput.value.trim();
    if (!varName) return;
    const msg = { action: "ADD", varName };
    sendWS(msg);
    toggleButtons(true);
  };

  document.getElementById('btnUnsub').onclick = () => {
    const varName = varInput.value.trim();
    if (!varName) return;
    const msg = { action: "REMOVE", varName };
    sendWS(msg);
    toggleButtons(false);
  };

  function testReenvio() {
    appendLog('üîÅ Simula reenviar √∫ltimo mensaje: espera mensaje autom√°tico al suscribirse.', 'info');
  }

  function sendCustom() {
    const varName = varInput.value.trim();
    if (!varName) return;
    const custom = prompt("Mensaje personalizado en JSON:", '{"type":"CUSTOM","message":"Hola desde cliente"}');
    try {
      const parsed = JSON.parse(custom);
      sendWS(parsed);
    } catch (e) {
      appendLog('‚ùå Error al parsear JSON', 'error');
    }
  }

  function sendWS(obj) {
    const msg = JSON.stringify(obj);
    socket.send(msg);
    appendLog('üöÄ Enviado:\n' + JSON.stringify(obj, null, 2), 'send');
  }

  function toggleButtons(subscribed) {
    document.getElementById('btnSub').disabled = subscribed;
    document.getElementById('btnUnsub').disabled = !subscribed;
  }

  function appendLog(text, type = 'info') {
    const time = new Date().toLocaleTimeString();
    const span = document.createElement('div');
    span.className = 'log-' + type;
    span.innerText = `[${time}] ${text}`;
    logEl.appendChild(span);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function clearLog() {
    logEl.innerHTML = '';
  }

  window.addEventListener('beforeunload', () => {
    const varName = varInput.value.trim();
    if (socket.readyState === WebSocket.OPEN && varName) {
      socket.send(JSON.stringify({ action: "REMOVE", varName }));
    }
  });
</script>
</body>
</html>
